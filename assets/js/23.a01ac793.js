(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{305:function(r,e,t){"use strict";t.r(e);var v=t(14),_=Object(v.a)({},(function(){var r=this,e=r._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":r.$parent.slotKey}},[e("h2",{attrs:{id:""}},[e("a",{staticClass:"header-anchor",attrs:{href:"#"}},[r._v("#")]),r._v(" /")]),r._v(" "),e("h4",{attrs:{id:"命名规划"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#命名规划"}},[r._v("#")]),r._v(" 命名规划")]),r._v(" "),e("blockquote",[e("p",[r._v("严格区分文件、目录、路径、名称。")])]),r._v(" "),e("p",[r._v("docFile---------表示doc对象（File）"),e("br"),r._v("docFileDir------表示doc所在目录对象（File）"),e("br"),r._v("docFilePath-----表示doc路径（String）"),e("br"),r._v("docFileDirPath--表示doc所在目录路径（String）"),e("br"),r._v("docFileName-----表示doc名称（String）"),e("br"),r._v("docFileDirName--表示doc所在目录名称（String）")]),r._v(" "),e("h4",{attrs:{id:"路径规划"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#路径规划"}},[r._v("#")]),r._v(" 路径规划")]),r._v(" "),e("p",[r._v("原始文件目录：/upload/"),e("br"),r._v("临时文件目录：/clouder/temporary/"),e("br"),r._v("文档本地目录：/clouder/document/"),e("br"),r._v("图片本地目录：/clouder/picture/"),e("br"),r._v("页面本地目录：/clouder/page/")]),r._v(" "),e("h4",{attrs:{id:"错误-异常规划"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#错误-异常规划"}},[r._v("#")]),r._v(" 错误/异常规划")]),r._v(" "),e("p",[r._v("1、采用具体异常类，比如：拷贝写异常、移动写异常、新增写异常、下载写异常、推送写异常、克隆写异常。"),e("br"),r._v("2、项目中的异常处理（分层架构）："),e("br"),r._v("控制层，不用考虑异常，下图。"),e("br"),r._v("业务层，需要考虑异常，捕获异常并抛出自定义异常，再统一交给异常工具类评估。"),e("br"),r._v("工具层，不用考虑异常，直接抛给业务层处理。"),e("br"),e("img",{attrs:{src:"https://jiq-picture.yuxing138.top/f375bed138e3a9d7cafe99b1e3f4b0ec/1689859183880-f319f1b0-a6fc-4c67-8630-dbd3f4487cf1.png#averageHue=%23c6751c&clientId=ue89c5d7b-711e-4&from=paste&height=900&id=u3bd8aa70&originHeight=1800&originWidth=2880&originalType=binary&ratio=2&rotation=0&showTitle=false&size=441971&status=done&style=none&taskId=u7e300463-29cc-4cf4-9fb5-1705279d450&title=&width=1440",alt:"image.png"}})]),r._v(" "),e("h4",{attrs:{id:"图床规划"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#图床规划"}},[r._v("#")]),r._v(" 图床规划")]),r._v(" "),e("p",[r._v("1、背景：一个文档分配一个图片文件夹；兼容文档重命名时，图片文件夹不变。"),e("br"),r._v("2、索引的基本架构：使用“哈希桶组”作为一级索引，使用“有序队列”作为二级索引。"),e("br"),r._v("3、索引的具体实现："),e("br"),r._v("使用完整的哈希值作为哈希桶组，长度为2^32(21亿)。如果存放在一个索引文件中，文件过大，还需要对索引进行分层。由于产品的定位不是大型图床，不采用此方案。"),e("br"),r._v("使用长度为62^3的哈希桶组作为一级索引，每个桶分配62个小桶。大概可容纳1500万个文档，个人文档库一般不超过1万。这样索引文件只有100K，适合个人图床，决定采用此方案。"),e("br"),r._v("4、怎么避免图片覆盖？")]),r._v(" "),e("blockquote",[e("p",[r._v("每个桶只分配62个小桶。如果用户的文档非常多，某个桶的冲突超过62次且文档中的图片名称相同，则会出现图片覆盖。")])]),r._v(" "),e("p",[r._v("（1）通过图片前缀来避免图片覆盖，每次文档重命名都会造成图片浪费，不采用此方案。"),e("br"),r._v("（2）让用户自行保证图片名称唯一，以避免图片覆盖，不采用此方案。"),e("br"),r._v("（3）直接限制每个小桶只能存放61个文档的图片（哈希冲突达到61次后提醒），以避免图片覆盖。由于是个人图床，决定采用此方案。"),e("br"),r._v("5、怎么保证索引文件的原子性？"),e("br"),r._v("（1）如果要保证两个文件（一级索引index1与二级索引index2）同时写入成功，锁定时间太长。"),e("br"),r._v("（2）"),e("code",[r._v("二级索引index2")]),r._v("依赖"),e("code",[r._v("一级索引index1")]),r._v("，但多个"),e("code",[r._v("二级索引index2")]),r._v("之间并不相互依赖。因此不用同时锁定两个索引文件，"),e("code",[r._v("一级索引index1")]),r._v("与"),e("code",[r._v("二级索引index2")]),r._v("各自使用一把锁。"),e("br"),r._v("6、怎么保证文档的一致性？"),e("br"),r._v("（1）发现异常，写操作需要回滚，读操作无需回滚。"),e("br"),r._v("（2）每个文档保存一个操作列表用于回滚。"),e("br"),r._v("（3）文档在回滚的过程中，"),e("code",[r._v("二级索引index2")]),r._v("要锁定。")])])}),[],!1,null,null,null);e.default=_.exports}}]);