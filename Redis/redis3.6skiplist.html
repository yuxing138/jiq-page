<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>/ | YuXing138</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.d9f1b266.js" as="script"><link rel="preload" href="/assets/js/2.ae7b2f73.js" as="script"><link rel="preload" href="/assets/js/1.5784faf9.js" as="script"><link rel="preload" href="/assets/js/51.a5818d76.js" as="script"><link rel="prefetch" href="/assets/js/10.11cd5bbe.js"><link rel="prefetch" href="/assets/js/11.d6f242fd.js"><link rel="prefetch" href="/assets/js/12.52955fb8.js"><link rel="prefetch" href="/assets/js/13.0171e0e6.js"><link rel="prefetch" href="/assets/js/14.e8630228.js"><link rel="prefetch" href="/assets/js/15.e3fe6a55.js"><link rel="prefetch" href="/assets/js/16.ed16aad5.js"><link rel="prefetch" href="/assets/js/17.9f06ecf6.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/19.66f6de90.js"><link rel="prefetch" href="/assets/js/20.2e3db1a8.js"><link rel="prefetch" href="/assets/js/21.ce1d45a6.js"><link rel="prefetch" href="/assets/js/22.da4a9ea1.js"><link rel="prefetch" href="/assets/js/23.a01ac793.js"><link rel="prefetch" href="/assets/js/24.26a55b7b.js"><link rel="prefetch" href="/assets/js/25.87a96766.js"><link rel="prefetch" href="/assets/js/26.7a4ce183.js"><link rel="prefetch" href="/assets/js/27.06278435.js"><link rel="prefetch" href="/assets/js/28.c0038d39.js"><link rel="prefetch" href="/assets/js/29.0f971c3a.js"><link rel="prefetch" href="/assets/js/3.e5de98dd.js"><link rel="prefetch" href="/assets/js/30.0f08cc8c.js"><link rel="prefetch" href="/assets/js/31.688edc58.js"><link rel="prefetch" href="/assets/js/32.9fc39a8d.js"><link rel="prefetch" href="/assets/js/33.9a111fa3.js"><link rel="prefetch" href="/assets/js/34.4f23ce16.js"><link rel="prefetch" href="/assets/js/35.5aa6dd66.js"><link rel="prefetch" href="/assets/js/36.43a95f57.js"><link rel="prefetch" href="/assets/js/37.0b236ba2.js"><link rel="prefetch" href="/assets/js/38.b600f07d.js"><link rel="prefetch" href="/assets/js/39.e77021b6.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.e5dc69c4.js"><link rel="prefetch" href="/assets/js/41.fd4968d3.js"><link rel="prefetch" href="/assets/js/42.d3e66f9e.js"><link rel="prefetch" href="/assets/js/43.e89cf854.js"><link rel="prefetch" href="/assets/js/44.334f7f93.js"><link rel="prefetch" href="/assets/js/45.4314cbfb.js"><link rel="prefetch" href="/assets/js/46.3945a8ca.js"><link rel="prefetch" href="/assets/js/47.cceeb8bb.js"><link rel="prefetch" href="/assets/js/48.5f50271c.js"><link rel="prefetch" href="/assets/js/49.4d28080b.js"><link rel="prefetch" href="/assets/js/5.9221cc65.js"><link rel="prefetch" href="/assets/js/50.fb6f7fc8.js"><link rel="prefetch" href="/assets/js/52.0d75acd1.js"><link rel="prefetch" href="/assets/js/53.4281924f.js"><link rel="prefetch" href="/assets/js/54.7fe4b62c.js"><link rel="prefetch" href="/assets/js/55.a3e4a681.js"><link rel="prefetch" href="/assets/js/6.08529f20.js"><link rel="prefetch" href="/assets/js/7.d6f7c6a1.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">YuXing138</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Clouder Menu" class="dropdown-title"><span class="title">Clouder</span> <span class="arrow down"></span></button> <button type="button" aria-label="Clouder Menu" class="mobile-dropdown-title"><span class="title">Clouder</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Clouder/Clouder.html" class="nav-link">
  Clouder
</a></li><li class="dropdown-item"><!----> <a href="/Clouder/Clouder源码介绍.html" class="nav-link">
  Clouder源码介绍
</a></li><li class="dropdown-item"><!----> <a href="/Clouder/怎么开源.html" class="nav-link">
  怎么开源
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch Menu" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch Menu" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.1环境安装.html" class="nav-link">
  es1.1环境安装
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.2一些概念.html" class="nav-link">
  es1.2一些概念
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.3一些API.html" class="nav-link">
  es1.3一些API
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.4查询.html" class="nav-link">
  es1.4查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.5聚合查询.html" class="nav-link">
  es1.5聚合查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.6ORM.html" class="nav-link">
  es1.6ORM
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.7分析器.html" class="nav-link">
  es1.7分析器
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.8脚本语言.html" class="nav-link">
  es1.8脚本语言
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.9搜索建议.html" class="nav-link">
  es1.9搜索建议
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.1高可用性.html" class="nav-link">
  es2.1高可用性
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.2搜索查询.html" class="nav-link">
  es2.2搜索查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.3倒排索引.html" class="nav-link">
  es2.3倒排索引
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.4地理查询.html" class="nav-link">
  es2.4地理查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.5一些概念.html" class="nav-link">
  es2.5一些概念
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.6相似性评分.html" class="nav-link">
  es2.6相似性评分
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.7索引.html" class="nav-link">
  es2.7索引
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java面试题 Menu" class="dropdown-title"><span class="title">Java面试题</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java面试题 Menu" class="mobile-dropdown-title"><span class="title">Java面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java面试题/一些面试题.html" class="nav-link">
  一些面试题
</a></li><li class="dropdown-item"><!----> <a href="/Java面试题/面试经典150题.html" class="nav-link">
  面试经典150题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Redis Menu" class="dropdown-title"><span class="title">Redis</span> <span class="arrow down"></span></button> <button type="button" aria-label="Redis Menu" class="mobile-dropdown-title"><span class="title">Redis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Redis/redis1.1数据类型.html" class="nav-link">
  redis1.1数据类型
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis2.1数据交互.html" class="nav-link">
  redis2.1数据交互
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.1Redis对象.html" class="nav-link">
  redis3.1Redis对象
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.2LFU算法.html" class="nav-link">
  redis3.2LFU算法
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.3dict.html" class="nav-link">
  redis3.3dict
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.4embstr.html" class="nav-link">
  redis3.4embstr
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.5hash.html" class="nav-link">
  redis3.5hash
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.6skiplist.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  redis3.6skiplist
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.1持久性.html" class="nav-link">
  redis4.1持久性
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.2副本.html" class="nav-link">
  redis4.2副本
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.3哨兵.html" class="nav-link">
  redis4.3哨兵
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.4集群.html" class="nav-link">
  redis4.4集群
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Clouder Menu" class="dropdown-title"><span class="title">Clouder</span> <span class="arrow down"></span></button> <button type="button" aria-label="Clouder Menu" class="mobile-dropdown-title"><span class="title">Clouder</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Clouder/Clouder.html" class="nav-link">
  Clouder
</a></li><li class="dropdown-item"><!----> <a href="/Clouder/Clouder源码介绍.html" class="nav-link">
  Clouder源码介绍
</a></li><li class="dropdown-item"><!----> <a href="/Clouder/怎么开源.html" class="nav-link">
  怎么开源
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch Menu" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch Menu" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.1环境安装.html" class="nav-link">
  es1.1环境安装
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.2一些概念.html" class="nav-link">
  es1.2一些概念
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.3一些API.html" class="nav-link">
  es1.3一些API
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.4查询.html" class="nav-link">
  es1.4查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.5聚合查询.html" class="nav-link">
  es1.5聚合查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.6ORM.html" class="nav-link">
  es1.6ORM
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.7分析器.html" class="nav-link">
  es1.7分析器
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.8脚本语言.html" class="nav-link">
  es1.8脚本语言
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es1.9搜索建议.html" class="nav-link">
  es1.9搜索建议
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.1高可用性.html" class="nav-link">
  es2.1高可用性
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.2搜索查询.html" class="nav-link">
  es2.2搜索查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.3倒排索引.html" class="nav-link">
  es2.3倒排索引
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.4地理查询.html" class="nav-link">
  es2.4地理查询
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.5一些概念.html" class="nav-link">
  es2.5一些概念
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.6相似性评分.html" class="nav-link">
  es2.6相似性评分
</a></li><li class="dropdown-item"><!----> <a href="/Elasticsearch/es2.7索引.html" class="nav-link">
  es2.7索引
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java面试题 Menu" class="dropdown-title"><span class="title">Java面试题</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java面试题 Menu" class="mobile-dropdown-title"><span class="title">Java面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java面试题/一些面试题.html" class="nav-link">
  一些面试题
</a></li><li class="dropdown-item"><!----> <a href="/Java面试题/面试经典150题.html" class="nav-link">
  面试经典150题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Redis Menu" class="dropdown-title"><span class="title">Redis</span> <span class="arrow down"></span></button> <button type="button" aria-label="Redis Menu" class="mobile-dropdown-title"><span class="title">Redis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Redis/redis1.1数据类型.html" class="nav-link">
  redis1.1数据类型
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis2.1数据交互.html" class="nav-link">
  redis2.1数据交互
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.1Redis对象.html" class="nav-link">
  redis3.1Redis对象
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.2LFU算法.html" class="nav-link">
  redis3.2LFU算法
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.3dict.html" class="nav-link">
  redis3.3dict
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.4embstr.html" class="nav-link">
  redis3.4embstr
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.5hash.html" class="nav-link">
  redis3.5hash
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis3.6skiplist.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  redis3.6skiplist
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.1持久性.html" class="nav-link">
  redis4.1持久性
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.2副本.html" class="nav-link">
  redis4.2副本
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.3哨兵.html" class="nav-link">
  redis4.3哨兵
</a></li><li class="dropdown-item"><!----> <a href="/Redis/redis4.4集群.html" class="nav-link">
  redis4.4集群
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Redis/redis1.1数据类型.html" class="sidebar-link">redis1.1数据类型</a></li><li><a href="/Redis/redis2.1数据交互.html" class="sidebar-link">redis2.1数据交互</a></li><li><a href="/Redis/redis3.1Redis对象.html" class="sidebar-link">redis3.1Redis对象</a></li><li><a href="/Redis/redis3.2LFU算法.html" class="sidebar-link">redis3.2LFU算法</a></li><li><a href="/Redis/redis3.3dict.html" class="sidebar-link">redis3.3dict</a></li><li><a href="/Redis/redis3.4embstr.html" class="sidebar-link">redis3.4embstr</a></li><li><a href="/Redis/redis3.5hash.html" class="sidebar-link">redis3.5hash</a></li><li><a href="/Redis/redis3.6skiplist.html" aria-current="page" class="active sidebar-link">redis3.6skiplist</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#" class="sidebar-link">/</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#跳表的结构" class="sidebar-link" style="padding-left:3rem;">跳表的结构</a></li><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#redis跳表" class="sidebar-link" style="padding-left:3rem;">Redis跳表</a></li><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#根据rank获取node" class="sidebar-link" style="padding-left:4rem;">根据rank获取node</a></li><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#根据节点-score与ele-获取rank" class="sidebar-link" style="padding-left:4rem;">根据节点(score与ele)获取rank</a></li><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#插入节点-score与ele" class="sidebar-link" style="padding-left:4rem;">插入节点(score与ele)</a></li><li class="sidebar-sub-header"><a href="/Redis/redis3.6skiplist.html#删除节点-score与ele" class="sidebar-link" style="padding-left:4rem;">删除节点(score与ele)</a></li></ul></li></ul></li><li><a href="/Redis/redis4.1持久性.html" class="sidebar-link">redis4.1持久性</a></li><li><a href="/Redis/redis4.2副本.html" class="sidebar-link">redis4.2副本</a></li><li><a href="/Redis/redis4.3哨兵.html" class="sidebar-link">redis4.3哨兵</a></li><li><a href="/Redis/redis4.4集群.html" class="sidebar-link">redis4.4集群</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id=""><a href="#" class="header-anchor">#</a> /</h2> <h4 id="跳表的结构"><a href="#跳表的结构" class="header-anchor">#</a> 跳表的结构</h4> <p><img src="https://jiq-picture.yuxing138.top/bde405a610b9c5cf97a29eb6a56205fd/1702308895677-72ce1dd2-1e4a-4e1a-ab7c-9f4724fdb728.png#averageHue=%23f3f3f3&amp;clientId=u1d04066b-b1a4-4&amp;from=paste&amp;height=452&amp;id=u96a778f7&amp;originHeight=1130&amp;originWidth=1983&amp;originalType=binary&amp;ratio=2.5&amp;rotation=0&amp;showTitle=false&amp;size=92265&amp;status=done&amp;style=none&amp;taskId=u3d15a584-7733-4209-af8d-a5a53387dec&amp;title=&amp;width=793.2" alt="image.png"><br><code>跳表</code>和<code>B+树</code>都是存放索引的数据结构，两者有相似之处，可以把<code>跳表</code>也视为分块树：</p> <ul><li><code>B+树</code>的块是固定的，<code>跳表</code>的块是随机的。</li> <li><code>B+树</code>只有3层，<code>跳表</code>有32层。</li> <li><code>B+树</code>是从上往下形成，<code>跳表</code>是从下往上形成。</li></ul> <h4 id="redis跳表"><a href="#redis跳表" class="header-anchor">#</a> Redis跳表</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>typedef struct zskiplistNode { //表示一个节点
    sds ele;       //value
    double score;  //分数
    struct zskiplistNode *backward;
    struct zskiplistLevel {           //层链表
        struct zskiplistNode *forward;//当前层的下一个节点
        unsigned long span;           //与下一个节点的跨度
    } level[];  //层数组
} zskiplistNode;

typedef struct zskiplist {  //表示一个跳表
    struct zskiplistNode *header, *tail;
    unsigned long length;
    int level;
} zskiplist;

typedef struct zset {
    dict *dict;
    zskiplist *zsl;
} zset;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Struct to hold an inclusive/exclusive range spec by score comparison. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> min<span class="token punctuation">,</span> max<span class="token punctuation">;</span>
    <span class="token keyword">int</span> minex<span class="token punctuation">,</span> maxex<span class="token punctuation">;</span> <span class="token comment">/* are min or max exclusive? */</span>
<span class="token punctuation">}</span> zrangespec<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>zrange key min max [BYSCORE|BYLEX] [REV] [LIMIT offset count] [WITHSCORES]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="根据rank获取node"><a href="#根据rank获取node" class="header-anchor">#</a> 根据rank获取node</h5> <p>每个node都有score、span。</p> <blockquote><p>注意：score并不能表示node的真实位置rank，但是span可以。这也是redis跳表的特殊之处。</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code>zskiplistNode<span class="token operator">*</span> <span class="token function">zslGetElementByRank</span><span class="token punctuation">(</span>zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> rank<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    zskiplistNode <span class="token operator">*</span>x<span class="token punctuation">;</span>           <span class="token comment">//当前节点</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> traversed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//当前节点rank</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    x <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">;</span> <span class="token comment">//从头节点开始遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//从最上层开始遍历</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>traversed <span class="token operator">+</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> rank<span class="token punctuation">)</span> <span class="token comment">//下一节点非空 &amp;&amp; 下一节点的rank&lt;rank</span>
        <span class="token punctuation">{</span>
            traversed <span class="token operator">+=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span<span class="token punctuation">;</span><span class="token comment">//累计当前节点的rank</span>
            x <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>traversed <span class="token operator">==</span> rank<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当前节点rank=rank，返回当前节点</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h5 id="根据节点-score与ele-获取rank"><a href="#根据节点-score与ele-获取rank" class="header-anchor">#</a> 根据节点(score与ele)获取rank</h5> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">zslGetRank</span><span class="token punctuation">(</span>zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">,</span> <span class="token keyword">double</span> score<span class="token punctuation">,</span> sds ele<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    zskiplistNode <span class="token operator">*</span>x<span class="token punctuation">;</span>       <span class="token comment">//当前节点</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> rank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//当前节点rank</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    x <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">;</span> <span class="token comment">//从头节点开始遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//从最上层开始遍历</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">&lt;</span> score <span class="token operator">||</span> <span class="token comment">//下一节点的score&lt;score</span>
                <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">==</span> score <span class="token operator">&amp;&amp;</span> 
                <span class="token function">sdscmp</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>ele<span class="token punctuation">,</span>ele<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//下一节点的score=score &amp;&amp; 下一节点的ele不=ele</span>
            rank <span class="token operator">+=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span<span class="token punctuation">;</span> <span class="token comment">//累计当前节点rank</span>
            x <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* x might be equal to zsl-&gt;header, so test if obj is non-NULL */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>ele <span class="token operator">&amp;&amp;</span> <span class="token function">sdscmp</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>ele<span class="token punctuation">,</span>ele<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//当前节点的ele=ele，返回当前rank</span>
            <span class="token keyword">return</span> rank<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="插入节点-score与ele"><a href="#插入节点-score与ele" class="header-anchor">#</a> 插入节点(score与ele)</h5> <p>跳表的理想结构是：每隔一个节点生成一个层级节点；模拟二又树结构，以此达到搜索时间复杂度为O(log2n)。但是如果删除节点，可能会破坏理想结构，需要重构理想结构，需要大量运算。于是用概率的方式构造理想结构：每增加一个节点有1/2的概率增加一个层级、1/4的概率增加两个层级、1/8的概率增加三个层级。。当节点数量大于256时，通过概率构造的跳表接近理想结构。这样删除节点，只需从链表中去除即可，无需重构跳表。<br>Reids的跳表也是采用概率的方式构造，产生层级概率是1/4。当有序集合zset的节点数大于128（或有一个字符串长度大于64）时，使用跳表结构。</p> <blockquote><p>注意：插入一个节点时，如果随机层级很大，则每一层都要插入。</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code>zskiplistNode <span class="token operator">*</span><span class="token function">zslInsert</span><span class="token punctuation">(</span>zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">,</span> <span class="token keyword">double</span> score<span class="token punctuation">,</span> sds ele<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    zskiplistNode <span class="token operator">*</span>update<span class="token punctuation">[</span>ZSKIPLIST_MAXLEVEL<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>x<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> rank<span class="token punctuation">[</span>ZSKIPLIST_MAXLEVEL<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> level<span class="token punctuation">;</span>

    <span class="token function">serverAssert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isnan</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">;</span> <span class="token comment">//从头节点开始遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//从最上层开始遍历</span>
        <span class="token comment">/* store rank that is crossed to reach the insert position */</span>
        rank<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">==</span> <span class="token punctuation">(</span>zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> rank<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//i层的rank = i+1层的rank</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">&lt;</span> score <span class="token operator">||</span> <span class="token comment">//i层的下一节点score&lt;插入节点score</span>
                    <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">==</span> score <span class="token operator">&amp;&amp;</span>
                    <span class="token function">sdscmp</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>ele<span class="token punctuation">,</span>ele<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//i层的下一节点score=插入节点score &amp;&amp; i层的ele不=ele</span>
        <span class="token punctuation">{</span>
            rank<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span<span class="token punctuation">;</span> <span class="token comment">//累计i层的rank</span>
            x <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        update<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">//说明i层不包含'插入节点'，x的下一节点是'插入节点'的存放位置，注意：用update指向这里的x</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* we assume the element is not already inside, since we allow duplicated
     * scores, reinserting the same element should never happen since the
     * caller of zslInsert() should test in the hash table if the element is
     * already inside or not. */</span>
    level <span class="token operator">=</span> <span class="token function">zslRandomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">&gt;</span> zsl<span class="token operator">-&gt;</span>level<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果随机层数&gt;跳表层数，则添加n层</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>level<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> level<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rank<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            update<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">;</span>
            update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        zsl<span class="token operator">-&gt;</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    x <span class="token operator">=</span> <span class="token function">zslCreateNode</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span>score<span class="token punctuation">,</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//把'插入节点'构造为节点x（注意：这里的x不是上面的x）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> level<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">//从最下层开始遍历直到最上层，逐层插入'插入节点'</span>
        x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">=</span> update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span> <span class="token comment">//在update[i]后面插入x（即：在上面的x后面插入'插入节点'）</span>
        update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">=</span> x<span class="token punctuation">;</span>                   <span class="token comment">//</span>

        <span class="token comment">/* update span covered by update[i] as x is inserted here */</span>
        x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">=</span> update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">-</span> <span class="token punctuation">(</span>rank<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> rank<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//span</span>
        update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">=</span> <span class="token punctuation">(</span>rank<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> rank<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">//span</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* increment span for untouched levels */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> level<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zsl<span class="token operator">-&gt;</span>level<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span<span class="token operator">++</span><span class="token punctuation">;</span>              <span class="token comment">//span</span>
    <span class="token punctuation">}</span>

    x<span class="token operator">-&gt;</span>backward <span class="token operator">=</span> <span class="token punctuation">(</span>update<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> update<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//backward</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">)</span>
        x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>backward <span class="token operator">=</span> x<span class="token punctuation">;</span>                       <span class="token comment">//backward</span>
    <span class="token keyword">else</span>
        zsl<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> x<span class="token punctuation">;</span>
    zsl<span class="token operator">-&gt;</span>length<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h5 id="删除节点-score与ele"><a href="#删除节点-score与ele" class="header-anchor">#</a> 删除节点(score与ele)</h5> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">zslDelete</span><span class="token punctuation">(</span>zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">,</span> <span class="token keyword">double</span> score<span class="token punctuation">,</span> sds ele<span class="token punctuation">,</span> zskiplistNode <span class="token operator">*</span><span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    zskiplistNode <span class="token operator">*</span>update<span class="token punctuation">[</span>ZSKIPLIST_MAXLEVEL<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    x <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>header<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">&lt;</span> score <span class="token operator">||</span>
                    <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>score <span class="token operator">==</span> score <span class="token operator">&amp;&amp;</span>
                     <span class="token function">sdscmp</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>ele<span class="token punctuation">,</span>ele<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            x <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        update<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* We may have multiple elements with the same score, what we need
     * is to find the element with both the right score and object. */</span>
    x <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> score <span class="token operator">==</span> x<span class="token operator">-&gt;</span>score <span class="token operator">&amp;&amp;</span> <span class="token function">sdscmp</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>ele<span class="token punctuation">,</span>ele<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">zslDeleteNode</span><span class="token punctuation">(</span>zsl<span class="token punctuation">,</span> x<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span>
            <span class="token function">zslFreeNode</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token operator">*</span>node <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* not found */</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">zslDeleteNode</span><span class="token punctuation">(</span>zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">,</span> zskiplistNode <span class="token operator">*</span>x<span class="token punctuation">,</span> zskiplistNode <span class="token operator">*</span><span class="token operator">*</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zsl<span class="token operator">-&gt;</span>level<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">==</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">+=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">=</span> x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>span <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward<span class="token operator">-&gt;</span>backward <span class="token operator">=</span> x<span class="token operator">-&gt;</span>backward<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        zsl<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> x<span class="token operator">-&gt;</span>backward<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>zsl<span class="token operator">-&gt;</span>level <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> zsl<span class="token operator">-&gt;</span>header<span class="token operator">-&gt;</span>level<span class="token punctuation">[</span>zsl<span class="token operator">-&gt;</span>level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forward <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        zsl<span class="token operator">-&gt;</span>level<span class="token operator">--</span><span class="token punctuation">;</span>
    zsl<span class="token operator">-&gt;</span>length<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Redis/redis3.5hash.html" class="prev">
        redis3.5hash
      </a></span> <span class="next"><a href="/Redis/redis4.1持久性.html">
        redis4.1持久性
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9f1b266.js" defer></script><script src="/assets/js/2.ae7b2f73.js" defer></script><script src="/assets/js/1.5784faf9.js" defer></script><script src="/assets/js/51.a5818d76.js" defer></script>
  </body>
</html>
